#!/bin/bash

pkgname=xz
pkgver=5.0.5
pkgrel=1
pkgdesc="Library and command line tools for XZ and LZMA compressed files"
arch=(any)
url="http://tukaani.org/xz/"
license=('GPL' 'LGPL')
source=(http://tukaani.org/$pkgname/$pkgname-$pkgver.tar.bz2)
md5sums=('db44efe0d53ac4317627624b98c63da0')

backup() {
  mv $1 $1.$2
}

universal() {
  echo "#ifdef __x86_64__" > $1
  cat $1.x86_64 >> $1
  echo "#else" >> $1
  cat $1.i386 >> $1
  echo "#endif" >> $1
}

build() {
  export CC="clang"
  export CXX="clang++"
  config="--prefix=/usr/local --disable-nls"

  cd $srcdir/$pkgname-$pkgver
  old=`mktemp $pkgname.XXXXXX`
  CC="$CC -arch i386" CXX="$CXX -arch i386" \
    ./configure ${config}
  HEADERS=`find * -newer $old -name "*.h"`
  rm -f $old
  for header in $HEADERS; do
    msg "backup $header i386"
    backup $header i386
  done

  make distclean
  ./configure ${config}
  for header in $HEADERS; do
    if ! cmp $header.i386 $header >/dev/null; then
      backup $header x86_64
      msg "universal $header"
      universal $header
    fi
  done

  pushd src/liblzma
  make CFLAGS="$CFLAGS -arch i386 -arch x86_64" CXXFLAGS="-arch i386 -arch x86_64"
  popd

  make
}

package() {
  cd $srcdir/$pkgname-$pkgver
  make DESTDIR=$pkgdir install
}
